<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ulplanet.trip.modules.tim.dao.GuideDao">

    <sql id="guideColumns">
        a.id,
        a.`name`,
        a.city AS 'city.id',
        c.`name` AS 'city.name',
        a.description,
        a.published,
        a.create_by AS 'createBy.id',
        a.update_by AS 'updateBy.id'
    </sql>
	<select id="findList" resultType="Guide">
		SELECT
            <include refid="guideColumns"/>,
            sc.name AS 'createBy.name',
            su.name AS 'updateBy.name'
        FROM guide a
        JOIN city c
        ON a.city = c.id
        LEFT JOIN sys_user sc
        ON a.create_by = sc.id
        LEFT JOIN sys_user su
        ON a.update_by = su.id
        <where>
            <if test="name != null and name != ''">
                AND a.name like CONCAT('%', #{name}, '%')
            </if>
            <if test="city != null and city.id != null and city.id != ''">
                AND a.city = #{city.id}
            </if>
            <if test="createBy != null and createBy.name != null and createBy.name != ''">
                AND sc.name like CONCAT('%', #{createBy.name}, '%')
            </if>
            <if test="updateBy != null and updateBy.name != null and updateBy.name != ''">
                AND su.name like CONCAT('%', #{updateBy.name}, '%')
            </if>
        </where>
        <choose>
            <when test="page !=null and page.orderBy != null and page.orderBy != ''">
                ORDER BY ${page.orderBy}
            </when>
            <otherwise>
                ORDER BY a.name
            </otherwise>
        </choose>
	</select>
    <select id="get" resultType="Guide">
        SELECT
        <include refid="guideColumns"/>
        FROM guide a
        JOIN city c
        ON a.city = c.id
        WHERE a.id = #{id}
    </select>
	<insert id="insert">
        INSERT INTO guide(
            id,
            name,
            city,
            description,
            published,
            create_by,
            create_date,
            update_by,
            update_date,
            remarks
        ) VALUES (
            #{id},
            #{name},
            #{city.id},
            #{description},
            #{published},
            #{createBy.id},
            #{createDate},
            #{updateBy.id},
            #{updateDate},
            #{remarks}
        )
	</insert>
	
	<update id="update">
        UPDATE guide SET
            name = #{name},
            city = #{city.id},
            description = #{description},
            published = #{published},
            update_by = #{updateBy.id},
            update_date = #{updateDate},
            remarks = #{remarks}
        WHERE id = #{id}
	</update>
	<delete id="delete">
        DELETE FROM guide WHERE id = #{id}
	</delete>

    <insert id="insertFile">
        INSERT INTO guide_file(
        id,
        guide,
        name,
        type,
        description,
        path,
        create_by,
        create_date,
        update_by,
        update_date,
        remarks
        ) VALUES (
        #{id},
        #{guide},
        #{name},
        #{type},
        #{description},
        #{path},
        #{createBy.id},
        #{createDate},
        #{updateBy.id},
        #{updateDate},
        #{remarks}
        )
    </insert>

    <sql id="guideFileColumns">
        a.id,
        a.name,
        a.type,
        a.description,
        a.path
    </sql>

    <select id="getFileById" resultType="GuideFile">
        SELECT
        <include refid="guideFileColumns"/>
        FROM guide_file a
        WHERE a.id = #{fileId}
    </select>

    <select id="findGuideFiles" resultType="GuideFile">
        SELECT
        <include refid="guideFileColumns"/>
        FROM guide_file a
        WHERE guide = #{guide}
        ORDER BY type
    </select>
    <update id="updateGuideFile">
        UPDATE guide_file
        <set>
            type=#{type},
            description=#{description}
        </set>
        WHERE id = #{id}
    </update>
    <delete id="deleteGuideFileById">
        DELETE FROM guide_file WHERE id = #{id}
    </delete>
    <delete id="deleteGuideFileByGuide">
        DELETE FROM guide_file WHERE guide = #{guide}
    </delete>
</mapper>